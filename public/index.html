<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Top Musica LivePix</title>
    <style>
      :root {
        --bg: #0b0f14;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.085);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.6);
        --ok: #41d37d;
        --warn: #f2c14e;
        --bad: #ff5d5d;
        --accent: #7ae6ff;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        background: radial-gradient(1200px 800px at 20% -10%, rgba(122, 230, 255, 0.18), transparent 60%),
          radial-gradient(900px 700px at 100% 0%, rgba(65, 211, 125, 0.12), transparent 55%),
          linear-gradient(180deg, #070a0f, var(--bg));
        color: var(--text);
        font-family: var(--sans);
      }

      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 22px 16px 60px;
      }

      header {
        display: flex;
        gap: 10px;
        align-items: baseline;
        justify-content: space-between;
        flex-wrap: wrap;
        margin-bottom: 16px;
      }

      h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
      }

      .status {
        display: flex;
        gap: 10px;
        align-items: center;
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--bad);
        box-shadow: 0 0 0 4px rgba(255, 93, 93, 0.12);
      }

      .dot.ok {
        background: var(--ok);
        box-shadow: 0 0 0 4px rgba(65, 211, 125, 0.12);
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      @media (min-width: 920px) {
        .grid {
          grid-template-columns: 1.25fr 0.75fr;
        }
      }

      .card {
        background: linear-gradient(180deg, var(--panel2), var(--panel));
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        overflow: hidden;
      }

      .card h2 {
        margin: 0;
        padding: 12px 12px 10px;
        font-size: 13px;
        letter-spacing: 0.28px;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.72);
        font-family: var(--mono);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }

      .card .body {
        padding: 12px;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .pill {
        font-family: var(--mono);
        font-size: 12px;
        color: rgba(255, 255, 255, 0.78);
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 6px 10px;
        border-radius: 999px;
      }

      .pill strong {
        color: var(--accent);
      }

      .btns {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      button {
        appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.92);
        padding: 8px 10px;
        border-radius: 10px;
        font-family: var(--mono);
        font-size: 12px;
        cursor: pointer;
      }

      button:hover {
        border-color: rgba(122, 230, 255, 0.35);
        background: rgba(122, 230, 255, 0.12);
      }

      button.mini {
        padding: 6px 8px;
        font-size: 11px;
      }

      input[type="text"] {
        appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.92);
        padding: 8px 10px;
        border-radius: 10px;
        font-family: var(--mono);
        font-size: 12px;
        width: min(100%, 260px);
      }

      input[type="text"]::placeholder {
        color: rgba(255, 255, 255, 0.45);
      }

      .muted {
        color: var(--muted);
        font-family: var(--mono);
        font-size: 12px;
      }

      .list {
        display: grid;
        gap: 8px;
      }

      .item {
        display: grid;
        gap: 3px;
        padding: 10px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .item .topline {
        display: flex;
        gap: 10px;
        align-items: baseline;
        justify-content: space-between;
      }

      .item .who {
        font-family: var(--mono);
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
      }

      .item .val {
        font-family: var(--mono);
        font-size: 12px;
        color: rgba(255, 255, 255, 0.88);
      }

      .item .msg {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.86);
        line-height: 1.35;
        word-break: break-word;
      }

      .item .meta {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        font-family: var(--mono);
        font-size: 11px;
        color: rgba(255, 255, 255, 0.62);
      }

      .k {
        color: rgba(255, 255, 255, 0.72);
      }

      footer {
        margin-top: 14px;
        text-align: center;
        font-family: var(--mono);
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
      }

      footer a {
        color: rgba(122, 230, 255, 0.92);
        text-decoration: none;
        border-bottom: 1px solid rgba(122, 230, 255, 0.35);
      }

      footer a:hover {
        border-bottom-color: rgba(122, 230, 255, 0.75);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Top Musica LivePix (Captando)</h1>
        <div class="status">
          <span id="dot" class="dot"></span>
          <span id="conn">desconectado</span>
          <span class="k">|</span>
          <span id="rulesPath">rules: -</span>
          <span class="k">|</span>
          <span id="version">versão: -</span>
        </div>
      </header>

      <div class="grid">
        <section class="card">
          <h2>Doacoes</h2>
          <div class="body">
            <div class="row" style="margin-bottom: 10px">
              <div class="pill">
                Top: <strong id="topName">-</strong> <span id="topValue">R$ 0</span>
              </div>
              <div class="pill">
                Player:
                <strong id="playerStatus">-</strong>
              </div>
            </div>

            <div class="list" id="donations"></div>
            <div class="muted" id="donationsEmpty" style="margin-top: 10px">
              Aguardando webhook...
            </div>
          </div>
        </section>

        <aside class="card">
          <h2>Musica</h2>
          <div class="body">
            <div class="row" style="margin-bottom: 10px">
              <div class="btns">
                <button id="skipBtn">skip</button>
                <button id="clearBtn">clear</button>
                <button id="reloadBtn">reload rules</button>
              </div>
              <div class="muted" id="lastWebhook">-</div>
            </div>

            <div class="item" style="margin-bottom: 10px">
              <div class="topline">
                <div class="who" id="nowWho">Agora: -</div>
                <div class="val" id="nowVal">-</div>
              </div>
              <div class="msg" id="nowMsg">Sem musica tocando</div>
              <div class="meta" id="nowMeta"></div>
            </div>

            <div class="muted" style="margin-bottom: 6px">Fila</div>
            <div class="list" id="queue"></div>
            <div class="muted" id="queueEmpty" style="margin-top: 10px">
              fila vazia
            </div>
          </div>
        </aside>
      </div>

      <div class="grid" style="margin-top: 12px">
        <section class="card">
          <h2>Auditoria e Relatorios (24h)</h2>
          <div class="body">
            <div class="row" style="margin-bottom: 10px">
              <div class="pill">Doacoes: <strong id="sumDonations">0</strong></div>
              <div class="pill">Total: <strong id="sumValue">R$ 0</strong></div>
              <div class="pill">Ticket: <strong id="sumAvg">R$ 0</strong></div>
              <div class="pill">Bloqueadas: <strong id="sumBlocked">0</strong></div>
            </div>

            <div class="muted" style="margin-bottom: 6px">Top doadores (24h)</div>
            <div class="list" id="topSenders"></div>
            <div class="muted" id="topSendersEmpty" style="margin-top: 10px">sem dados</div>

            <div class="muted" style="margin: 12px 0 6px">Ultimos eventos</div>
            <div class="list" id="auditEvents"></div>
            <div class="muted" id="auditEmpty" style="margin-top: 10px">sem eventos</div>
          </div>
        </section>

        <aside class="card">
          <h2>Moderacao</h2>
          <div class="body">
            <div class="row" style="margin-bottom: 8px">
              <input id="senderInput" type="text" placeholder="Nome do usuario" />
              <button id="blockSenderBtn">bloquear nome</button>
            </div>

            <div class="row" style="margin-bottom: 12px">
              <input id="keywordInput" type="text" placeholder="Palavra-chave" />
              <button id="blockKeywordBtn">bloquear palavra</button>
            </div>

            <div class="muted" id="modStatus" style="margin-bottom: 8px">-</div>

            <div class="muted" style="margin-bottom: 6px">Nomes bloqueados</div>
            <div class="list" id="blockedSenders"></div>
            <div class="muted" id="blockedSendersEmpty" style="margin-top: 10px">
              nenhum nome bloqueado
            </div>

            <div class="muted" style="margin: 12px 0 6px">Palavras bloqueadas</div>
            <div class="list" id="blockedKeywords"></div>
            <div class="muted" id="blockedKeywordsEmpty" style="margin-top: 10px">
              nenhuma palavra bloqueada
            </div>
          </div>
        </aside>
      </div>

      <footer>
        Apoiar o programador:
        <a href="https://livepix.gg/captando" target="_blank" rel="noreferrer">livepix.gg/captando</a>
      </footer>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const dot = document.getElementById("dot");
      const conn = document.getElementById("conn");
      const rulesPath = document.getElementById("rulesPath");
      const versionEl = document.getElementById("version");

      const donationsEl = document.getElementById("donations");
      const donationsEmpty = document.getElementById("donationsEmpty");
      const topName = document.getElementById("topName");
      const topValue = document.getElementById("topValue");
      const playerStatus = document.getElementById("playerStatus");

      const skipBtn = document.getElementById("skipBtn");
      const clearBtn = document.getElementById("clearBtn");
      const reloadBtn = document.getElementById("reloadBtn");

      const nowWho = document.getElementById("nowWho");
      const nowVal = document.getElementById("nowVal");
      const nowMsg = document.getElementById("nowMsg");
      const nowMeta = document.getElementById("nowMeta");

      const queueEl = document.getElementById("queue");
      const queueEmpty = document.getElementById("queueEmpty");
      const lastWebhook = document.getElementById("lastWebhook");
      const sumDonations = document.getElementById("sumDonations");
      const sumValue = document.getElementById("sumValue");
      const sumAvg = document.getElementById("sumAvg");
      const sumBlocked = document.getElementById("sumBlocked");
      const topSendersEl = document.getElementById("topSenders");
      const topSendersEmpty = document.getElementById("topSendersEmpty");
      const auditEvents = document.getElementById("auditEvents");
      const auditEmpty = document.getElementById("auditEmpty");

      const senderInput = document.getElementById("senderInput");
      const keywordInput = document.getElementById("keywordInput");
      const blockSenderBtn = document.getElementById("blockSenderBtn");
      const blockKeywordBtn = document.getElementById("blockKeywordBtn");
      const blockedSendersEl = document.getElementById("blockedSenders");
      const blockedKeywordsEl = document.getElementById("blockedKeywords");
      const blockedSendersEmpty = document.getElementById("blockedSendersEmpty");
      const blockedKeywordsEmpty = document.getElementById("blockedKeywordsEmpty");
      const modStatus = document.getElementById("modStatus");

      function formatBRL(v) {
        try {
          return new Intl.NumberFormat("pt-BR", {
            style: "currency",
            currency: "BRL"
          }).format(Number(v) || 0);
        } catch {
          return `R$ ${Number(v) || 0}`;
        }
      }

      function escapeHtml(s) {
        return String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function relTime(ts) {
        if (!ts) return "-";
        const d = Date.now() - Number(ts);
        if (!Number.isFinite(d)) return "-";
        if (d < 1000) return "agora";
        if (d < 60_000) return `${Math.floor(d / 1000)}s`;
        if (d < 3_600_000) return `${Math.floor(d / 60_000)}m`;
        return `${Math.floor(d / 3_600_000)}h`;
      }

      function formatDateTime(ts) {
        const n = Number(ts);
        if (!Number.isFinite(n) || n <= 0) return "-";
        try {
          return new Date(n).toLocaleString("pt-BR");
        } catch {
          return "-";
        }
      }

      function setModStatus(text, isError = false) {
        modStatus.textContent = text || "-";
        modStatus.style.color = isError ? "var(--bad)" : "var(--muted)";
      }

      async function apiPost(url, payload) {
        const resp = await fetch(url, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload || {})
        });
        const json = await resp.json().catch(() => ({}));
        if (!resp.ok || !json?.ok) {
          const msg = json?.error || `HTTP ${resp.status}`;
          throw new Error(msg);
        }
        return json;
      }

      function renderSummary(summary) {
        const totals = summary?.totals || {};
        sumDonations.textContent = String(totals.donations || 0);
        sumValue.textContent = formatBRL(totals.value || 0);
        sumAvg.textContent = formatBRL(totals.averageValue || 0);
        sumBlocked.textContent = String(totals.blockedDonations || 0);
      }

      function renderTopSenders(items) {
        const rows = Array.isArray(items) ? items : [];
        topSendersEl.innerHTML = "";

        for (const item of rows) {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="topline">
              <div class="who">${escapeHtml(item.sender || "-")}</div>
              <div class="val">${formatBRL(item.totalValue || 0)}</div>
            </div>
            <div class="meta">
              <span>doacoes: ${Number(item.donations) || 0}</span>
              <span>ultima: ${formatDateTime(item.lastAt)}</span>
            </div>
          `;
          topSendersEl.appendChild(div);
        }

        topSendersEmpty.style.display = rows.length ? "none" : "block";
      }

      function eventDetails(e) {
        const t = String(e?.type || "");
        if (t === "donation.accepted") {
          return `${escapeHtml(e.sender || "-")} • ${formatBRL(e.value || 0)}${e.isNewTop ? " • novo top" : ""}`;
        }
        if (t === "donation.blocked") {
          return `${escapeHtml(e.sender || "-")} • ${escapeHtml(e.reason || "-")} (${escapeHtml(e.blockMatch || "-")})`;
        }
        if (t === "action.executed") {
          const status = e.skipped ? "skipped" : e.ok ? "ok" : "fail";
          return `${escapeHtml(e.actionType || "-")} • ${status}${e.reason ? " • " + escapeHtml(e.reason) : ""}`;
        }
        if (t.startsWith("moderation.")) {
          return `${escapeHtml(e.sender || e.keyword || "-")}${e.reason ? " • " + escapeHtml(e.reason) : ""}`;
        }
        return escapeHtml(e.reason || e.message || "-");
      }

      function renderAuditEvents(events) {
        const rows = Array.isArray(events) ? events : [];
        auditEvents.innerHTML = "";

        for (const e of rows) {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="topline">
              <div class="who">${escapeHtml(e.type || "-")}</div>
              <div class="val">${relTime(e.at)} atrás</div>
            </div>
            <div class="msg">${eventDetails(e)}</div>
            <div class="meta">
              <span>${formatDateTime(e.at)}</span>
              ${e.donationId ? `<span>donationId: ${escapeHtml(e.donationId)}</span>` : ""}
            </div>
          `;
          auditEvents.appendChild(div);
        }

        auditEmpty.style.display = rows.length ? "none" : "block";
      }

      function renderModerationList({ rows, container, emptyLabel, onUnblock, field }) {
        container.innerHTML = "";
        const list = Array.isArray(rows) ? rows : [];

        for (const item of list) {
          const div = document.createElement("div");
          div.className = "item";

          const btn = document.createElement("button");
          btn.className = "mini";
          btn.textContent = "desbloquear";
          btn.addEventListener("click", async () => {
            try {
              await onUnblock(item.label || item.value || "");
              setModStatus("item desbloqueado");
            } catch (e) {
              setModStatus(`erro: ${String(e?.message || e)}`, true);
            }
          });

          const top = document.createElement("div");
          top.className = "topline";
          top.innerHTML = `
            <div class="who">${escapeHtml(item.label || item.value || "-")}</div>
            <div class="val">${formatDateTime(item.at)}</div>
          `;
          top.appendChild(btn);

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.innerHTML = `
            <span>${field}: ${escapeHtml(item.value || "-")}</span>
            ${item.reason ? `<span>motivo: ${escapeHtml(item.reason)}</span>` : ""}
          `;

          div.appendChild(top);
          div.appendChild(meta);
          container.appendChild(div);
        }

        emptyLabel.style.display = list.length ? "none" : "block";
      }

      async function loadAuditAndReports() {
        try {
          const [summaryResp, topResp, auditResp] = await Promise.all([
            fetch("/api/reports/summary?hours=24", { cache: "no-store" }),
            fetch("/api/reports/top-senders?hours=24&limit=8", { cache: "no-store" }),
            fetch("/api/audit?hours=24&limit=20", { cache: "no-store" })
          ]);

          const summary = await summaryResp.json();
          const top = await topResp.json();
          const audit = await auditResp.json();

          if (summary?.ok) renderSummary(summary);
          if (top?.ok) renderTopSenders(top.senders);
          if (audit?.ok) renderAuditEvents(audit.events);
        } catch {
          // Keep dashboard running even if report endpoints fail temporarily.
        }
      }

      async function loadModeration() {
        try {
          const resp = await fetch("/api/moderation", { cache: "no-store" });
          const json = await resp.json();
          if (!json?.ok) return;

          const data = json.data || {};
          renderModerationList({
            rows: data.blockedSenders || [],
            container: blockedSendersEl,
            emptyLabel: blockedSendersEmpty,
            field: "sender",
            onUnblock: async (sender) => {
              await apiPost("/api/moderation/senders/unblock", { sender });
              await loadModeration();
              await loadAuditAndReports();
            }
          });
          renderModerationList({
            rows: data.blockedKeywords || [],
            container: blockedKeywordsEl,
            emptyLabel: blockedKeywordsEmpty,
            field: "keyword",
            onUnblock: async (keyword) => {
              await apiPost("/api/moderation/keywords/unblock", { keyword });
              await loadModeration();
              await loadAuditAndReports();
            }
          });
        } catch {
          // Silent; connection can recover automatically.
        }
      }

      function setState(state) {
        const s = state || {};

        if (s.topDonation) {
          topName.textContent = s.topDonation.sender || "-";
          topValue.textContent = formatBRL(s.topDonation.value);
        } else {
          topName.textContent = "-";
          topValue.textContent = "R$ 0";
        }

        const p = s.player || {};
        playerStatus.textContent =
          p.connected && p.ready ? "ready" : p.connected ? "conectado" : "off";

        const m = s.music || {};
        const cur = m.current;
        if (cur) {
          nowWho.textContent = `Agora: ${cur.requestedBy || "-"}`;
          nowVal.textContent = formatBRL(cur.value);
          nowMsg.textContent = cur.url || cur.message || "-";
          const meta = [];
          if (cur.vip) meta.push("VIP");
          if (cur.videoId) meta.push(`yt:${cur.videoId}`);
          nowMeta.textContent = meta.join(" | ");
        } else {
          nowWho.textContent = "Agora: -";
          nowVal.textContent = "-";
          nowMsg.textContent = "Sem musica tocando";
          nowMeta.textContent = "";
        }

        const q = Array.isArray(m.queue) ? m.queue : [];
        queueEl.innerHTML = "";
        for (const t of q.slice(0, 25)) {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="topline">
              <div class="who">${escapeHtml(t.requestedBy || "-")}</div>
              <div class="val">${formatBRL(t.value)}</div>
            </div>
            <div class="msg">${escapeHtml(t.url || "-")}</div>
            <div class="meta">${t.vip ? "VIP" : "fila"}${t.videoId ? " | yt:" + escapeHtml(t.videoId) : ""}</div>
          `;
          queueEl.appendChild(div);
        }
        queueEmpty.style.display = q.length ? "none" : "block";

        const dons = Array.isArray(s.donations) ? s.donations : [];
        donationsEl.innerHTML = "";
        for (const d of dons.slice(0, 25)) {
          const div = document.createElement("div");
          div.className = "item";
          const acts = (d.actions || []).map((a) => a.type).join(", ");
          div.innerHTML = `
            <div class="topline">
              <div class="who">${escapeHtml(d.sender || "-")}</div>
              <div class="val">${formatBRL(d.value)}</div>
            </div>
            <div class="msg">${escapeHtml(d.message || "")}</div>
            <div class="meta">
              <span>${relTime(d.at)} atrás</span>
              ${d.url ? `<span>url</span>` : ""}
              ${acts ? `<span>actions: ${escapeHtml(acts)}</span>` : ""}
            </div>
          `;
          donationsEl.appendChild(div);
        }
        donationsEmpty.style.display = dons.length ? "none" : "block";

        lastWebhook.textContent = s.lastWebhookAt
          ? `webhook: ${relTime(s.lastWebhookAt)} atrás`
          : "webhook: -";
      }

      const socket = io();

      socket.on("connect", () => {
        dot.classList.add("ok");
        conn.textContent = "conectado";
      });
      socket.on("disconnect", () => {
        dot.classList.remove("ok");
        conn.textContent = "desconectado";
      });

      socket.on("rules:loaded", (d) => {
        if (d && d.path) rulesPath.textContent = `rules: ${d.path}`;
      });
      socket.on("rules:reloaded", (d) => {
        if (d && d.path) rulesPath.textContent = `rules: ${d.path}`;
      });

      socket.on("state:init", (s) => setState(s));
      socket.on("state:update", (s) => setState(s));

      skipBtn.addEventListener("click", () => socket.emit("music:skip"));
      clearBtn.addEventListener("click", () => socket.emit("music:clearQueue"));
      reloadBtn.addEventListener("click", async () => {
        await fetch("/api/rules/reload", { method: "POST" });
      });

      blockSenderBtn.addEventListener("click", async () => {
        const sender = String(senderInput.value || "").trim();
        if (!sender) {
          setModStatus("informe um nome para bloquear", true);
          return;
        }
        try {
          await apiPost("/api/moderation/senders/block", { sender, reason: "manual_dashboard" });
          senderInput.value = "";
          setModStatus("nome bloqueado");
          await loadModeration();
          await loadAuditAndReports();
        } catch (e) {
          setModStatus(`erro: ${String(e?.message || e)}`, true);
        }
      });

      blockKeywordBtn.addEventListener("click", async () => {
        const keyword = String(keywordInput.value || "").trim();
        if (!keyword) {
          setModStatus("informe uma palavra para bloquear", true);
          return;
        }
        try {
          await apiPost("/api/moderation/keywords/block", {
            keyword,
            reason: "manual_dashboard"
          });
          keywordInput.value = "";
          setModStatus("palavra bloqueada");
          await loadModeration();
          await loadAuditAndReports();
        } catch (e) {
          setModStatus(`erro: ${String(e?.message || e)}`, true);
        }
      });

      async function loadVersion() {
        try {
          const resp = await fetch("/api/version", { cache: "no-store" });
          const v = await resp.json();
          if (!v || !v.ok) {
            versionEl.textContent = "versão: erro";
            return;
          }

          const localSha = v.local?.git?.commitShort || "";
          const localSubj = v.local?.git?.subject || "";
          const remoteOk = v.remote?.ok === true;
          const remoteSha = remoteOk ? v.remote?.commitShort || "" : "";
          const remoteSubj = remoteOk ? v.remote?.subject || "" : "";
          const remoteAuthor = remoteOk ? v.remote?.author || "" : "";
          const remoteDate = remoteOk ? v.remote?.date || "" : "";
          const remotePkgVersion = remoteOk ? v.remote?.packageVersion || "" : "";

          let remoteWhen = "";
          if (remoteDate) {
            const d = new Date(remoteDate);
            if (!Number.isNaN(d.getTime())) {
              remoteWhen = d.toLocaleString("pt-BR");
            }
          }

          let status = "indefinido";
          if (v.upToDate === true) status = "atualizado";
          else if (v.upToDate === false) status = "atualização disponível";

          const parts = [];
          if (v.local?.packageVersion) parts.push(`local v${v.local.packageVersion}`);
          if (remotePkgVersion) parts.push(`última v${remotePkgVersion}`);
          if (localSha) parts.push(`local ${localSha}`);
          else parts.push("local sem git");
          if (remoteSha) parts.push(`remoto ${remoteSha}`);
          parts.push(status);

          const detail =
            remoteOk && remoteSubj
              ? ` | último commit: ${remoteSha} ${remoteSubj}${remoteAuthor ? " (" + remoteAuthor + ")" : ""}${remoteWhen ? " • " + remoteWhen : ""}`
              : remoteOk
                ? ""
                : " | não foi possível checar o GitHub";

          versionEl.textContent = `versão: ${parts.join(" · ")}${detail}`;
        } catch {
          versionEl.textContent = "versão: erro";
        }
      }

      loadVersion();
      setInterval(loadVersion, 60_000);
      loadAuditAndReports();
      loadModeration();
      setInterval(loadAuditAndReports, 15_000);
      setInterval(loadModeration, 15_000);
    </script>
  </body>
</html>
